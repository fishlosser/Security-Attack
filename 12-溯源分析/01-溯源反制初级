流量分析溯源的思路？
假设发现 web 应用服务器发现文件异常增多，初步怀疑被上传 webshell，描述流量分析溯源的思路
可利用流量工具进行溯源：
1、查看 eval、z0、shell、whoami 等关键字，查看出现次数过多的时候，可能 需要查看是哪个页面发起的请求，有可能是 webshell
2、通过 WireShark 工具快速搜索关键字，定位到异常流量包
3、找出异常 IP 和所上传的内容，查看是否为 webshell

取证和溯源从哪些方面入手？
流量：流量分析可以使用Wireshark，主要分析下当前主机访问了哪些域名、URL、服务，或者有哪些外网IP在访问本地主机的哪些端口、服务和目录，又使用了何种协议（如比较少见的IRC协议流量）
内存：分析病毒内存文件，内存文件11275.dump，采用命令 strings -n8 11275.dump，获取长度8及以上的字符串内容，可能获得病毒的配置文件或原始病毒文件
启动项：采用命令行分析启动项或使用启动项分析工具autuoruns定位病毒启动项

举例系统误报的类型？
1、业务系统之间的调用请求，设备报警；
2、业务公司人员上生产系统上的poc测试（直接执行注入和远程读取命令），被系统误报成渗透攻击（这一条应该不算是误报，毕竟有攻击行为，只不过是自己人干的）；
3、centos系统自动更新系统文件，设备报警，未经授权的访问外网；
4、业务人员配置中间件，设备报警；

溯源反制
对外溯源：确认攻击者的真实身份
对外溯源 通过监测设备上面确定攻击 IP，确定是攻击者发起的请求，那么就通过这个 IP 确定域名，通过该域名查找到关于攻击者注册域名的一些相关信息。通常会有 QQ 账号、QQ 邮箱等个人真实信息，再借助这些有效信息去社工，进一步追溯攻击者的画像。
对内溯源：确认攻击者的行为

* 比如拿到数据：
web攻击事件-11
攻击时间: 2021-08-17 09:09:99
攻击IP : 49.70.0.xxx
预警平台：天眼/绿盟/ibm/长亭waf

攻击类型: 植入后门文件
处置方式: 封禁需溯源
目标域名: 10.0.0.1
www.baidu.com
*大概流程
1、ip进行定位、域名反查
2、可以对黑客主机攻陷，主动探测攻击证明
3、利用支付宝、淘宝、社工库等方式获取进一步信息

* 详细流程
1、针对 IP 通过开源情报 + 开放端口分析查询
首先通过威胁情报平台确认攻击 ip 是否为威胁 ip，常用的平台通常有如下
https://x.threatbook.cn/ 微步在线威胁情报社区
https://ti.qianxin.com/ 奇安信威胁情报中心
https://ti.360.cn/ 360威胁情报中心
https://www.venuseye.com.cn/  
VenusEye威胁情报中心

// 域名反查
站长之家IP查询网址：https://ip.tool.chinaz.com/ipbatch
IP138查询网：https://www.ip138.com/
高精度IP定位：https://www.opengps.cn/Data/IP/LocHighAcc.aspx
IP信息查询：https://www.ipip.net/ip.html/
IP地址查询在线工具：https://tool.lu/ip/
多地Ping检测：http://ping.chinaz.com/
Whois查询：https://whois.chinaz.com/
当发现 IP 的为攻击 IP 后，可以尝试通过此 IP 去溯源攻击者，具体实现过程通常会用到下述方法：
1. ip 反查域名
2. 域名查 whois 注册信息
3. 域名查备案信息、反查邮箱、反查注册人 http://whoissoft.com/
4. 邮箱反查下属域名
5. 注册人反查下属域名
然后，在端口：我们可以可查看一些开放服务进行进一步利用
再通过 nmap 对开放端口进行识别（主动探测）
nmap -p 3389,3306,6378 -Pn IP

2、查询定位
通过蜜罐等设备获取真实 IP，对 IP 进行定位，可定位具体位置。
定位 IP 网站：https://www.opengps.cn/Data/IP/ipplus.aspx（也可以用空间测绘工具天眼等进一步收集信息）
3、得到常用 ID 信息收集：
(1) 百度信息收集：“id” （双引号为英文）
(2) 谷歌信息收集
(3) src 信息收集（各大 src 排行榜，如果有名次交给我套路）
(4) 微博搜索（如果发现有微博记录，可使用 tg 查询 weibo 泄露数据）
(5) 微信 ID 收集：微信进行 ID 搜索（直接发钉钉群一起查）
(6) 如果获得手机号（可直接搜索支付宝确定目标姓氏、淘宝找回密码确定目标名字、社交账户等）
注意：获取手机号如果自己查到的信息不多，直接上报企业微信 / 钉钉群（利用共享渠道对其进行二次社工）
(7) 豆瓣 / 贴吧 / 知乎 / 脉脉 你能知道的所有社交平台，进行信息收集
4、预警设备信息取证：
上方数据一无所获，可考虑对其发起攻击的行为进行筛查，尝试判断其是否有指纹特征。
如看看不能上传 webshell ，在 webshell 中植入 probe.js，在 webshell 中增加 canvas 探针，获取  CPU，主板什么信息，如果对方用的 chrome 的话，并存在 Chrome UAF 0day ，CS 免杀客户端获得微信 ID
5、跳板机信息收集（触发）：
进入红队跳板机查询相关信息
如果主机桌面没有敏感信息，可针对下列文件进行信息收集
last：查看登录成功日志
cat ~/.bash_history  ：查看操作指令
ps -aux #查看进程
查看是否有类似 ID 的用户
重点关注 uid 为 500 以上的登录用户
nologin 为不可登录
注意：手机号、昵称 ID 均为重点数据，如查不到太多信息，直接上报指挥部。
* 附:
微步在线云沙箱：https://s.threatbook.cn/
腾讯哈勃：https://habo.qq.com/
Virustotal：https://www.virustotal.com/gui/home/upload
火眼：https://fireeye.ijinshan.com
魔盾安全分析：https://www.maldun.com/analysis/
    * 攻击者上传了恶意程序的话：
如果攻击者在恶意攻击过程中对目标资产上传攻击程序（如后门、恶意脚本、钓鱼程序等），我们可通过对攻击者上传的恶意程序进行分析，并通过 IP 定位等技术手段对攻击进行分析溯源，常用的恶意程序分析网站有：
    * 蜜罐溯源的两种常见方式：
一种是在伪装的网站上插入特定的 js 文件，该 js 文件使用攻击者浏览器中缓存的 cookies 去对各大社交系统的 JSONP、XSS、CSRF 接口获取攻击者的 ID  和手机号等。另一种是在伪装的网站上显示需要下载某插件，该插件一般为反制木马，控制了攻击者的主机后查询敏感文件、浏览器访问记录等个人敏感信息从而锁定攻击者。
    * 如果攻击者被蜜罐捕获的话：
蜜罐技术本质上是一种对攻击方进行欺骗的技术，通过布置一些作为诱饵的主机、网络服务或者信息，诱使攻击方对它们实施攻击，从而可以对攻击行为进行捕获和分析，了解攻击方所使用的工具与方法，推测攻击意图和动机，能够让防御方清晰地了解他们所面对的安全威胁，并通过技术和管理手段来增强实际系统的安全防护能力。
